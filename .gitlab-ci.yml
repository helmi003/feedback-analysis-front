variables:
  DOCKER_TLS_CERTDIR: '/certs'
  SONAR_HOST_URL: "https://158c6a719afc.ngrok-free.app"

default:
  image: node:22
  services:
    - docker:24.0.5-dind

stages:
  - install
  - test
  - build
  - monitoring
  - deploy

install-dependencies-job:
  stage: install
  script:
    - echo "Installing dependencies..."
    - yarn
    - echo "Dependencies installed."
  cache:
    key: deps-$CI_COMMIT_REF_SLUG
    paths:
      - node_modules/
  rules:
    - if: ($CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_TAG =~ /^production-/ || $CI_COMMIT_TAG =~ /^staging-/)

# unit-test-job:
#   stage: test
#   script:
#     - echo "Running unit tests..."
#     - yarn test:run
#     - echo "Unit tests completed."
#   cache:
#     key: deps-$CI_COMMIT_REF_SLUG
#     paths:
#       - node_modules/
#     policy: pull
#   needs: ['install-dependencies-job']
#   rules:
#     - if: ($CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_TAG =~ /^production-/ || $CI_COMMIT_TAG =~ /^staging-/)

# lint-test-job:
#   stage: test
#   cache:
#     key: deps-$CI_COMMIT_REF_SLUG
#     paths:
#       - node_modules/
#     policy: pull
#   needs: ['install-dependencies-job']
#   script:
#     - echo "Running lint tests..."
#     - yarn lint
#     - echo "Lint tests completed."
#   rules:
#     - if: ($CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_TAG =~ /^production-/ || $CI_COMMIT_TAG =~ /^staging-/)

# coverage-test-job:
#   stage: test
#   script:
#     - echo "Running tests with coverage..."
#     - yarn test:coverage
#     - echo "Coverage tests completed."
#   cache:
#     key: deps-$CI_COMMIT_REF_SLUG
#     paths:
#       - node_modules/
#     policy: pull
#   needs: ['install-dependencies-job']
#   artifacts:
#     reports:
#       coverage_report:
#         coverage_format: cobertura
#         path: coverage/cobertura-coverage.xml
#     paths:
#       - coverage/
#     expire_in: 1 week
#   rules:
#     - if: ($CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_TAG =~ /^production-/ || $CI_COMMIT_TAG =~ /^staging-/)

# sonar-test-job:
#   stage: test
#   image: sonarsource/sonar-scanner-cli:latest
#   variables:
#     SONAR_USER_HOME: '${CI_PROJECT_DIR}/.sonar'
#     GIT_DEPTH: '0'
#   script:
#     - echo "ðŸ” Starting SonarQube analysis..."
#     - echo "Using SonarQube server:" $SONAR_HOST_URL
#     - sonar-scanner
#   cache:
#     key: deps-$CI_COMMIT_REF_SLUG
#     paths:
#       - node_modules/
#     policy: pull
#   needs: ['install-dependencies-job', 'coverage-test-job']
#   rules:
#     - if: ($CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_TAG =~ /^production-/ || $CI_COMMIT_TAG =~ /^staging-/)

build-docker-image-job:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker info
    - echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
    - apk add --no-cache --upgrade bash git
  script:
    - echo "Building docker image..."
    - BUILD_ENVIRONMENT=$(echo "$CI_COMMIT_TAG" | cut -d '-' -f1)
    - echo "CI_COMMIT_REF_NAME is $CI_COMMIT_REF_NAME"
    - echo "BUILD_ENVIRONMENT is $BUILD_ENVIRONMENT"
    - chmod +x ./build-docker-image.sh
    - ./build-docker-image.sh $BUILD_ENVIRONMENT --push
  needs: ['install-dependencies-job']
  rules:
    - if: ($CI_COMMIT_TAG =~ /^staging-/ || $CI_COMMIT_TAG =~ /^production-/)

deploy-job:
  image: ubuntu:latest
  stage: deploy
  before_script:
    - apt update; apt install -y openssh-client
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ssh_key
    - chmod 600 ssh_key
    - mkdir -p ~/.ssh && touch ~/.ssh/known_hosts
    - ssh-keyscan $CI_VM_IPADDRESS >> ~/.ssh/known_hosts
  script:
    # Pull the latest image and restart the container
    - BUILD_ENVIRONMENT=$(echo "$CI_COMMIT_TAG" | cut -d '-' -f1)
    - |
      if [ "$BUILD_ENVIRONMENT" = "production" ]; then
        IMAGE_TAG="$CI_REGISTRY_IMAGE:production-$CI_COMMIT_SHA"
      else
        IMAGE_TAG="$CI_REGISTRY_IMAGE:staging-$CI_COMMIT_SHA"
      fi
    - echo "Deploying image: $IMAGE_TAG"
    - ssh -i ssh_key ubuntu@$CI_VM_IPADDRESS "
        echo '$CI_REGISTRY_PASSWORD' | docker login '$CI_REGISTRY' -u '$CI_REGISTRY_USER' --password-stdin &&
        docker pull $IMAGE_TAG &&
        docker stop feedback-frontend || true &&
        docker rm feedback-frontend || true &&
        docker run -d --name feedback-frontend -p 80:80 --restart unless-stopped $IMAGE_TAG &&
        docker image prune -f"
  needs: ['build-docker-image-job']
  rules:
    - if: ($CI_COMMIT_TAG =~ /^staging-/ || $CI_COMMIT_TAG =~ /^production-/)